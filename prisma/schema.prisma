generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres", "postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
}

generator zod {
  provider = "prisma-zod-generator"
  output   = "../src/generated/zod"
  config   = "zod-generator.config.json"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  CUSTOMER
  ADMIN

  @@map("user_role")
}

enum OrderStatus {
  PENDING
  PAYMENT_PROCESSING
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  FAILED
  CANCELLED

  @@map("order_status")
}

enum PaymentStatus {
  PENDING // Covers requires_payment_method + requires_confirmation
  REQUIRES_ACTION // Customer action needed (3D Secure)
  PROCESSING // Stripe processing
  SUCCEEDED // Complete
  FAILED // Any failure (declined, error, etc.)
  CANCELED // Canceled

  @@map("payment_status")
}

enum ShipmentStatus {
  PENDING
  SHIPPED
  IN_TRANSIT
  DELIVERED
  LOST
  RETURNED
  CANCELED

  @@map("shipment_status")
}

enum AddressType {
  SHIPPING
  BILLING

  @@map("address_type")
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  supabaseUserId String    @unique @map("supabase_user_id") @db.Uuid
  email          String    @unique @db.Citext
  name           String?   @db.VarChar(100)
  role           UserRole  @default(CUSTOMER)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime? @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  wishlist             Wishlist?
  cart                 Cart?
  orders               Order[]
  orderStatusHistories OrderStatusHistory[]

  @@map("users")
}

model ActiveUser {
  id             String   @id @db.Uuid
  supabaseUserId String   @map("supabase_user_id") @db.Uuid
  email          String   @db.Citext
  name           String?  @db.VarChar(100)
  role           UserRole
  createdAt      DateTime @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime? @map("updated_at") @db.Timestamptz(6)

  @@map("active_users")
}

// ============================================
// PRODUCTS & CATALOG
// ============================================

model Product {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String    @db.VarChar(150)
  description String?   @db.Text
  vendor      String?   @db.VarChar(100)
  categoryId  String    @map("category_id") @db.Uuid
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime? @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  category      Category            @relation(fields: [categoryId], references: [id])
  variants      ProductVariant[]
  images        ProductImage[]
  collections   ProductCollection[]
  wishlistItems WishlistItem[]
  cartItems     CartItem[]
  orderItems    OrderItem[]

  @@index([isActive])
  @@index([categoryId])
  @@map("products")
}

model ProductVariant {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId      String    @map("product_id") @db.Uuid
  name           String    @db.VarChar(100)
  price          BigInt    @db.BigInt
  currency       String    @default("CAD") @db.VarChar(3)
  stock          Int       @db.Integer
  reservedStock  Int       @default(0) @map("reserved_stock") @db.Integer
  imageObjectKey String?   @map("image_object_key") @db.VarChar(512)
  isActive       Boolean   @default(true) @map("is_active")
  sortOrder      Int       @default(0) @map("sort_order") @db.Integer
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime? @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  product    Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@unique([productId, name])
  @@unique([productId, sortOrder])
  @@index([productId, isActive])
  @@map("product_variants")
}

model ProductImage {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId String    @map("product_id") @db.Uuid
  objectKey String    @map("object_key") @db.VarChar(512)
  altText   String?   @map("alt_text") @db.VarChar(150)
  sortOrder Int       @default(0) @map("sort_order") @db.Integer
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime? @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, sortOrder])
  @@map("product_images")
}

model Category {
  id   String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name String @unique @db.VarChar(100)

  // Relations
  products Product[]

  @@map("categories")
}

model Collection {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String    @unique @db.VarChar(150)
  description String?   @db.Text
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime? @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  products ProductCollection[]

  @@map("collections")
}

model ProductCollection {
  productId    String @map("product_id") @db.Uuid
  collectionId String @map("collection_id") @db.Uuid
  sortOrder    Int    @default(0) @map("sort_order") @db.Integer

  // Relations
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([productId, collectionId])
  @@index([collectionId])
  @@map("product_collections")
}

// ============================================
// WISHLIST
// ============================================

model Wishlist {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @unique @map("user_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user  User           @relation(fields: [userId], references: [supabaseUserId], onDelete: Cascade)
  items WishlistItem[]

  @@map("wishlists")
}

model WishlistItem {
  id         String   @id @default(uuid()) @db.Uuid
  wishlistId String   @db.Uuid
  productId  String   @db.Uuid
  createdAt  DateTime @default(now()) @db.Timestamptz(6)

  wishlist Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@unique([wishlistId, productId])
  @@index([productId])
  @@map("wishlist_items")
}

// ============================================
// CART
// ============================================

model Cart {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @unique @map("user_id") @db.Uuid
  updatedAt DateTime? @updatedAt @map("updated_at") @db.Timestamptz(6)

  user  User       @relation(fields: [userId], references: [supabaseUserId], onDelete: Cascade)
  items CartItem[]

  @@map("carts")
}

model CartItem {
  id        String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cartId    String @map("cart_id") @db.Uuid
  productId String @map("product_id") @db.Uuid
  variantId String @map("variant_id") @db.Uuid
  quantity  Int    @db.Integer

  // Relations
  cart    Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product        @relation(fields: [productId], references: [id])
  variant ProductVariant @relation(fields: [variantId], references: [id])

  @@unique([cartId, variantId])
  @@map("cart_items")
}

// ============================================
// ORDERS
// ============================================

model Order {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderNumber    String      @unique @map("order_number") @db.VarChar(32)
  userId         String      @map("user_id") @db.Uuid
  status         OrderStatus @default(PENDING)
  subtotalAmount BigInt      @map("subtotal_amount") @db.BigInt
  taxAmount      BigInt      @default(dbgenerated("0")) @map("tax_amount") @db.BigInt
  shippingAmount BigInt      @default(dbgenerated("0")) @map("shipping_amount") @db.BigInt
  discountAmount BigInt      @default(dbgenerated("0")) @map("discount_amount") @db.BigInt

  totalAmount    BigInt      @map("total_amount") @db.BigInt
  currency       String      @default("CAD") @db.VarChar(3)
  metadata       Json?       @db.JsonB
  createdAt      DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime?   @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user          User                 @relation(fields: [userId], references: [supabaseUserId])
  items         OrderItem[]
  addresses     OrderAddress[]
  payments      Payment[]
  shipments     Shipment[]
  statusHistory OrderStatusHistory[]

  @@index([status])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@map("orders")
}

model OrderItem {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId     String  @map("order_id") @db.Uuid
  productId   String  @map("product_id") @db.Uuid
  variantId   String  @map("variant_id") @db.Uuid
  productName String  @map("product_name") @db.VarChar(150)
  variantName String? @map("variant_name") @db.VarChar(100)
  quantity    Int     @db.Integer
  unitPrice   BigInt  @map("unit_price") @db.BigInt
  currency    String  @default("CAD") @db.VarChar(3)

  // Relations
  order         Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product        @relation(fields: [productId], references: [id])
  variant       ProductVariant @relation(fields: [variantId], references: [id])
  shipmentItems ShipmentItem[]

  @@index([orderId])
  @@map("order_items")
}

model OrderAddress {
  id         String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId    String      @map("order_id") @db.Uuid
  type       AddressType
  name       String?     @db.VarChar(100)
  line1      String?     @db.VarChar(255)
  line2      String?     @db.VarChar(255)
  city       String?     @db.VarChar(100)
  state      String?     @db.VarChar(100)
  postalCode String?     @map("postal_code") @db.VarChar(20)
  country    String?     @db.VarChar(2)
  phone      String?     @db.VarChar(30)
  createdAt  DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime?   @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([orderId, type])
  @@map("order_addresses")
}

// ============================================
// PAYMENTS
// ============================================

model Payment {
  id                      String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId                 String        @map("order_id") @db.Uuid
  status                  PaymentStatus @default(PROCESSING)
  amount                  BigInt        @db.BigInt
  currency                String        @default("CAD") @db.VarChar(3)
  stripePaymentIntentId   String        @unique @map("stripe_payment_intent_id") @db.VarChar(255)
  stripeChargeId          String?       @unique @map("stripe_charge_id") @db.VarChar(255)
  stripeCheckoutSessionId String?       @unique @map("stripe_checkout_session_id") @db.VarChar(255)
  stripeCustomerId        String?       @map("stripe_customer_id") @db.VarChar(255)
  idempotencyKey          String?       @unique @map("idempotency_key") @db.VarChar(255)
  failureCode             String?       @map("failure_code") @db.VarChar(100)
  failureMessage          String?       @map("failure_message") @db.Text
  metadata                Json?         @db.JsonB
  createdAt               DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt               DateTime?     @updatedAt @map("updated_at") @db.Timestamptz(6)
  succeededAt             DateTime?     @map("succeeded_at") @db.Timestamptz(6)
  canceledAt              DateTime?     @map("canceled_at") @db.Timestamptz(6)

  // Relations
  order         Order                  @relation(fields: [orderId], references: [id], onDelete: Cascade)
  statusHistory PaymentStatusHistory[]

  @@index([orderId])
  @@index([status, createdAt])
  @@index([stripeCustomerId])
  @@map("payments")
}

// ============================================
// SHIPMENTS
// ============================================

model Shipment {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId        String         @map("order_id") @db.Uuid
  status         ShipmentStatus @default(PENDING)
  carrier        String?        @db.VarChar(50)
  serviceLevel   String?        @map("service_level") @db.VarChar(80)
  trackingNumber String?        @map("tracking_number") @db.VarChar(100)
  trackingUrl    String?        @map("tracking_url") @db.VarChar(512)
  shippedAt      DateTime?      @map("shipped_at") @db.Timestamptz(6)
  deliveredAt    DateTime?      @map("delivered_at") @db.Timestamptz(6)
  canceledAt     DateTime?      @map("canceled_at") @db.Timestamptz(6)
  metadata       Json?          @db.JsonB
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime?      @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  order Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  items ShipmentItem[]

  @@index([status, createdAt])
  @@index([orderId, createdAt])
  @@index([trackingNumber])
  @@map("shipments")
}

model ShipmentItem {
  id          String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shipmentId  String @map("shipment_id") @db.Uuid
  orderItemId String @map("order_item_id") @db.Uuid
  quantity    Int    @db.Integer

  // Relations
  shipment  Shipment  @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@unique([shipmentId, orderItemId])
  @@index([orderItemId])
  @@map("shipment_items")
}

// ============================================
// AUDIT & HISTORY
// ============================================

model OrderStatusHistory {
  id         String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId    String       @map("order_id") @db.Uuid
  fromStatus OrderStatus? @map("from_status")
  toStatus   OrderStatus  @map("to_status")
  reason     String?      @db.Text
  changedBy  String?      @map("changed_by") @db.Uuid
  createdAt  DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt  DateTime?    @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User? @relation(fields: [changedBy], references: [supabaseUserId])

  @@index([orderId, createdAt])
  @@map("order_status_history")
}

model PaymentStatusHistory {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  paymentId     String         @map("payment_id") @db.Uuid
  fromStatus    PaymentStatus? @map("from_status")
  toStatus      PaymentStatus  @map("to_status")
  reason        String?        @db.Text
  stripeEventId String?        @map("stripe_event_id") @db.VarChar(255)
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime?      @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId, createdAt])
  @@index([stripeEventId])
  @@map("payment_status_history")
}

// ============================================
// WEBHOOKS
// ============================================

model WebhookEvent {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  stripeEventId       String    @unique @map("stripe_event_id") @db.VarChar(255)
  type                String    @db.VarChar(100)
  payload             Json      @db.JsonB
  processed           Boolean   @default(false)
  processedAt         DateTime? @map("processed_at") @db.Timestamptz(6)
  processingStartedAt DateTime? @map("processing_started_at") @db.Timestamptz(6)
  errorMessage        String?   @map("error_message") @db.Text
  retryCount          Int       @default(0) @map("retry_count") @db.Integer
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime? @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([processed, createdAt])
  @@index([type])
  @@map("webhook_events")
}
